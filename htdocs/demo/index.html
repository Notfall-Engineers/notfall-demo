


<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Notfall Engineers – Multi-Role Demo (Engineer / Client-FM / DAO)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- React stack -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind (layout helpers only) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- ✅ Global API (your file should set window.notfall_demoAPI) -->
    <script src="./FakeAPI.js"></script>

    <style>
      :root {
        --nf-primary: #3a7bff;
        --nf-primary-alt: #7a3fff;
        --nf-accent: #00e1b4;
        --nf-danger: #ff3b30;

        --nf-dark-bg: radial-gradient(circle at top left, #172554 0, #020617 55%, #020617 100%);
        --nf-dark-shell: radial-gradient(circle at 8% -20%, #1d4ed8 0, #020617 55%);
        --nf-dark-panel: radial-gradient(circle at -10% -40%, #1d4ed8 0, #020617 60%);
        --nf-dark-widget: radial-gradient(circle at -20% -40%, #1d4ed8 0, #020617 70%);

        --nf-text-dark: #e5edf8;
        --nf-text-muted-dark: #9ca3af;

        --nf-radius-xl: 30px;
        --nf-radius-lg: 26px;
        --nf-radius-md: 18px;
      }

      html, body, #root { height: 100%; }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
          "Segoe UI", Roboto, Arial, sans-serif;
        -webkit-font-smoothing: antialiased;
        background: var(--nf-dark-bg);
        color: var(--nf-text-dark);
      }

      /* App bar */
      .nf-appbar {
        position: sticky; top: 0; z-index: 50;
        background: radial-gradient(circle at 0% -80%, #1d4ed8 0, #020617 55%);
        box-shadow: 0 22px 60px rgba(0,0,0,0.85), 0 0 0 1px rgba(15,23,42,0.9);
        border-bottom: 1px solid rgba(30,64,175,0.8);
        backdrop-filter: blur(18px);
      }
      .nf-appbar-inner {
        max-width: 1280px;
        margin: 0 auto;
        padding: 18px 22px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 14px;
      }
      .nf-brand { display:flex; align-items:center; gap:12px; min-width:260px; }
      .nf-brand-logo {
        height: 36px; width: 128px; border-radius: 12px;
        background: radial-gradient(circle at 30% 20%, #38bdf8, #1d4ed8 60%, #22c55e 100%);
        display:flex; align-items:center; justify-content:center;
        overflow:hidden; box-shadow: 0 16px 40px rgba(15,23,42,0.85);
      }
      .nf-brand-title { font-weight: 800; font-size: 18px; letter-spacing: 0.03em; }
      .nf-brand-sub { font-size: 11px; opacity: 0.8; }

      .nf-chip {
        display:inline-flex; align-items:center; gap:6px;
        border-radius: 999px; padding: 4px 11px; font-size: 11px;
        background: radial-gradient(circle at 0 0, #16a34a 0, #052e16 50%, #020617 100%);
        color: #bbf7d0;
        box-shadow: 0 10px 30px rgba(22,163,74,0.75), 0 0 0 1px rgba(34,197,94,0.5);
        white-space: nowrap;
      }
      .nf-chip-dot { width:7px; height:7px; border-radius:999px; background:#22c55e; box-shadow: 0 0 14px rgba(34,197,94,0.9); }

      .nf-appbar-actions { display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end; }
      .nf-appbar-btn {
        border-radius: 999px;
        padding: 6px 14px;
        border: 1px solid rgba(148,163,184,0.7);
        background: radial-gradient(circle at 0 0, rgba(15,23,42,0.95), rgba(15,23,42,0.98));
        color: #e5e7eb;
        font-size: 11px;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 10px 26px rgba(15,23,42,0.95);
        transition: transform 0.1s ease, border-color 0.16s ease, filter 0.16s ease;
      }
      .nf-appbar-btn:hover { transform: translateY(-1px); border-color: #38bdf8; }
      .nf-appbar-btn:active { transform: translateY(0px); filter: brightness(0.98); }

      .nf-pill {
        display:inline-flex; align-items:center; gap:0.35rem;
        border-radius:999px;
        padding:0.18rem 0.65rem;
        font-size:0.72rem;
        font-weight:600;
        background: linear-gradient(145deg, #0f172a, #020617);
        color:#e5e7eb;
        border: 1px solid rgba(148,163,184,0.7);
        box-shadow: 0 6px 14px rgba(15,23,42,0.8);
        white-space: nowrap;
      }
      .nf-pill-beta {
        color: #ff3b30;
        border-color: rgba(248,113,113,0.9);
        box-shadow: 0 0 18px rgba(248,113,113,0.7);
      }

      .nf-root { min-height: 100vh; display:flex; flex-direction:column; }

      /* Main shell */
      .nf-shell-bg {
        max-width: 80rem;
        margin: 1.6rem auto 2.2rem;
        border-radius: var(--nf-radius-xl);
        padding: 1.4rem 1.2rem 1.6rem;
        background: var(--nf-dark-shell);
        box-shadow: 0 26px 70px rgba(15,23,42,0.9), 0 0 0 1px rgba(15,23,42,0.85);
      }

      .nf-layout {
        display:grid;
        grid-template-columns: 340px 1fr;
        gap:16px;
        align-items:start;
      }
      @media (max-width: 1040px) { .nf-layout { grid-template-columns: 1fr; } }

      .nf-panel-main {
        border-radius: var(--nf-radius-lg);
        padding: 1.4rem 1.5rem 1.5rem;
        background: var(--nf-dark-panel);
        box-shadow: 0 22px 60px rgba(15,23,42,0.85), 0 0 0 1px rgba(15,23,42,0.85);
        position: relative;
        overflow: hidden;
        border: 1px solid rgba(37,99,235,0.7);
      }

      .nf-panel-widget {
        border-radius: var(--nf-radius-lg);
        padding: 1.25rem 1.25rem;
        background: var(--nf-dark-widget);
        box-shadow: 0 18px 60px rgba(15,23,42,0.9), 0 0 0 1px rgba(15,23,42,0.9);
      }

      .nf-divider {
        height: 1px;
        width: 100%;
        background: linear-gradient(90deg, rgba(148,163,184,0), rgba(148,163,184,0.55), rgba(148,163,184,0));
        margin: 0.55rem 0;
      }

      /* Inputs + buttons */
      .nf-input {
        width:100%;
        border-radius:999px;
        border:1px solid rgba(148,163,184,0.55);
        padding: 0.6rem 1rem;
        background: radial-gradient(circle at top left, rgba(15,23,42,0.9), rgba(15,23,42,0.98));
        box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06), 0 12px 30px rgba(15,23,42,0.9);
        font-size: 0.9rem;
        color: #e5edf8;
      }
      .nf-input:focus {
        outline:none;
        border-color:#38bdf8;
        box-shadow: 0 0 0 1px rgba(56,189,248,0.8), 0 0 0 7px rgba(56,189,248,0.25);
      }
      textarea.nf-input { border-radius: 20px; min-height: 90px; resize: vertical; }

      .nf-btn-primary {
        display:inline-flex; align-items:center; justify-content:center; gap:0.45rem;
        border-radius:999px;
        padding:0.55rem 1.2rem;
        border:none;
        cursor:pointer;
        font-size:0.9rem;
        font-weight:700;
        background-image: linear-gradient(135deg, #2563eb, #4f46e5);
        color:white;
        box-shadow: 0 16px 40px rgba(37,99,235,0.9), 0 0 0 1px rgba(191,219,254,0.6);
        transition: transform 0.1s ease, filter 0.16s ease;
      }
      .nf-btn-primary:hover { transform: translateY(-1px); filter: brightness(1.05); }
      .nf-btn-primary:active { transform: translateY(0px); filter: brightness(0.98); }
      .nf-btn-primary:disabled { opacity: 0.45; cursor: default; box-shadow:none; }

      .nf-btn-ghost {
        display:inline-flex; align-items:center; justify-content:center; gap:0.4rem;
        border-radius:999px;
        padding:0.5rem 1rem;
        border: 1px solid rgba(148,163,184,0.7);
        background: radial-gradient(circle at top, rgba(15,23,42,0.95), rgba(15,23,42,0.98));
        cursor:pointer;
        font-size:0.86rem;
        font-weight:650;
        color:#e5e7eb;
        box-shadow: 0 8px 22px rgba(15,23,42,0.95);
        transition: transform 0.1s ease, border-color 0.16s ease, filter 0.16s ease;
      }
      .nf-btn-ghost:hover { transform: translateY(-1px); border-color: #38bdf8; }
      .nf-btn-ghost:active { transform: translateY(0px); filter: brightness(0.98); }

      /* Status */
      .nf-status-badge { border-radius:999px; padding: 3px 9px; font-size: 11px; font-weight: 800; }
      .nf-status-muted { background: rgba(15,23,42,0.7); color:#9ca3af; }
      .nf-status-pending { background: rgba(251,191,36,0.13); color:#fbbf24; }
      .nf-status-approved { background: rgba(16,185,129,0.17); color:#6ee7b7; }
      .nf-status-rejected { background: rgba(248,113,113,0.18); color:#fecaca; }

      /* Toast (warm, consistent typography) */
      .nf-toast-wrap { position: fixed; right: 16px; bottom: 18px; z-index: 80; display:flex; flex-direction:column; gap:10px; }
      .nf-toast {
        width: 340px; max-width: calc(100vw - 32px);
        border-radius: 18px;
        background: rgba(2,6,23,0.82);
        border: 1px solid rgba(148,163,184,0.35);
        box-shadow: 0 18px 60px rgba(0,0,0,0.55);
        padding: 12px 12px;
      }
      .nf-toast .t1 { font-size: 12px; font-weight: 900; color: #e5e7eb; }
      .nf-toast .t2 { font-size: 11px; color: rgba(226,232,240,0.75); margin-top: 2px; }
      .nf-toast .t3 { font-size: 10px; color: rgba(148,163,184,0.85); margin-top: 6px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }

      /* Modal (consistent font sizes) */
      .nf-modal-overlay {
        position: fixed; inset: 0;
        background: radial-gradient(circle at top, rgba(15,23,42,0.92), rgba(2,6,23,0.96));
        display:flex; align-items:center; justify-content:center;
        z-index: 70;
        padding: 18px;
      }
      .nf-modal {
        width: 760px;
        max-width: calc(100% - 24px);
        border-radius: 26px;
        background: radial-gradient(circle at -10% -40%, #1d4ed8, #020617 70%);
        box-shadow: 0 34px 110px rgba(0,0,0,0.96), 0 0 0 1px rgba(148,163,184,0.7);
        padding: 18px 18px 16px;
      }
      .nf-modal-title { font-size: 13px; font-weight: 900; letter-spacing: 0.12em; text-transform: uppercase; }
      .nf-modal-sub { font-size: 11px; color: rgba(226,232,240,0.75); margin-top: 6px; }
      .nf-modal-footer { display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top: 14px; }

      /* Left nav widgets */
      .nf-nav-title { font-size: 13px; font-weight: 900; letter-spacing: 0.12em; text-transform: uppercase; }
      .nf-nav-item {
        width: 100%;
        text-align: left;
        padding: 12px 12px;
        border-radius: 18px;
        border: 1px solid rgba(148,163,184,0.25);
        background: rgba(2,6,23,0.35);
        box-shadow: 0 14px 40px rgba(15,23,42,0.75);
        transition: transform 0.12s ease, border-color 0.16s ease, background 0.16s ease;
        cursor: pointer;
      }
      .nf-nav-item:hover { transform: translateY(-1px); border-color: rgba(56,189,248,0.75); background: rgba(2,6,23,0.52); }
      .nf-nav-item.active { border-color: rgba(56,189,248,0.95); background: rgba(56,189,248,0.08); }
      .nf-nav-item.locked { opacity: 0.55; filter: saturate(0.7); cursor: not-allowed; }
      .nf-nav-item .t1 { font-size: 12px; font-weight: 800; color: #e5e7eb; }
      .nf-nav-item .t2 { font-size: 11px; color: rgba(226,232,240,0.7); margin-top: 3px; }
    </style>
  </head>

  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useMemo, useRef } = React;

      // ✅ Canonical API name (with safe fallback)
      const api = window.notfall_demoAPI || window.FakeAPI || {};

      function ensureSocket() {
        try { return api.getWidgetSocket ? api.getWidgetSocket() : null; } catch { return null; }
      }

      // small helpers
      function timeAgo(iso) {
        if (!iso) return "just now";
        const d = new Date(iso);
        const diffMs = Date.now() - d.getTime();
        const sec = Math.max(1, Math.floor(diffMs / 1000));
        const min = Math.floor(sec / 60);
        const hr = Math.floor(min / 60);
        const day = Math.floor(hr / 24);
        if (day > 1) return `${day} days ago`;
        if (day === 1) return "1 day ago";
        if (hr > 1) return `${hr} hours ago`;
        if (hr === 1) return "1 hour ago";
        if (min > 1) return `${min} mins ago`;
        if (min === 1) return "1 min ago";
        return "just now";
      }

      function StatusBadge({ status }) {
        const s = String(status || "").toUpperCase();
        let cls = "nf-status-badge ";
        if (["PENDING","IN_REVIEW","NEW","OPEN","REQUESTED","AWAITING_EVIDENCE","EVIDENCE_SUBMITTED"].includes(s)) cls += "nf-status-pending";
        else if (["APPROVED","APPROVED_CERTIFIED","ACCEPTED","ENROUTE","ONSITE","COMPLETED","PAID"].includes(s)) cls += "nf-status-approved";
        else if (["REJECTED","DECLINED","FAILED","LOCKED"].includes(s)) cls += "nf-status-rejected";
        else cls += "nf-status-muted";
        return <span className={cls}>{status || "Unknown"}</span>;
      }

      // Offer sound + vibration (kept subtle)
      function playOfferSound() {
        try {
          const AudioCtx = window.AudioContext || window.webkitAudioContext;
          if (!AudioCtx) return;
          const ctx = new AudioCtx();
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.type = "sine";
          o.frequency.value = 880;
          g.gain.value = 0.0001;
          o.connect(g); g.connect(ctx.destination);
          const t = ctx.currentTime;
          g.gain.setValueAtTime(0.0001, t);
          g.gain.exponentialRampToValueAtTime(0.12, t + 0.02);
          g.gain.exponentialRampToValueAtTime(0.0001, t + 0.18);
          o.start(t); o.stop(t + 0.22);
          setTimeout(() => ctx.close().catch(()=>{}), 500);
        } catch {}
      }
      function vibrate(pattern=[70,40,70]) { try { navigator.vibrate && navigator.vibrate(pattern); } catch {} }

      // WS hook
      function useDemoBus(onEvent) {
        const onRef = useRef(onEvent);
        onRef.current = onEvent;
        useEffect(() => {
          const ws = ensureSocket();
          if (!ws) return;
          const handler = (evt) => {
            try {
              const msg = JSON.parse(evt.data);
              onRef.current && onRef.current(msg);
            } catch {}
          };
          ws.addEventListener("message", handler);

          // subscribe hint (DemoSocket accepts and ignores gracefully if not supported)
          try { ws.send(JSON.stringify({ type: "subscribe", topics: ["ticket","task","dao","profile","demographics","assetRegistry","plcAlert","partnerApi","engineerPools","reminder","system","escrow"] })); } catch {}

          return () => { try { ws.removeEventListener("message", handler); } catch {} };
        }, []);
      }

      // Normalisers for mixed message shapes
      function readMsg(msg) {
        const topic = String(msg?.topic || "").toLowerCase();
        const action = String(msg?.action || msg?.type || "").toLowerCase();

        // escrow message shape
        if (String(msg?.type || "").toLowerCase() === "escrow:update") {
          return { topic: "escrow", action: "update", payload: { status: msg.status, ledgerEntry: msg.ledgerEntry } };
        }

        // task payloads
        if (topic === "task") {
          const payload = msg.payload || msg;
          return { topic, action, payload };
        }

        return { topic, action, payload: msg.payload ?? msg };
      }

      function apiRole(role) {
        if (role === "dao") return "DAO_ADMIN";
        if (role === "client") return "CLIENT";
        return "ENGINEER";
      }
      // Widgets (left hub)
      const WIDGETS = [
        // Engineer
        { id:"eng_profile",   role:["engineer"], label:"Profile setup",   sub:"Certs, insurance, rates", gate:"open" },
        { id:"eng_dao",       role:["engineer"], label:"DAO approval",    sub:"Certification review",   gate:"open" },
        { id:"eng_inbox",     role:["engineer"], label:"Task inbox",      sub:"Live dispatch",          gate:"open", pill:"LIVE BETA" },
        { id:"eng_evidence",  role:["engineer"], label:"Evidence vault",  sub:"Before/after + notes",   gate:"open" },
        { id:"eng_id",        role:["engineer"], label:"Digital ID card", sub:"Shareable credential",   gate:"dao_approved" },

        // Client/FM
        { id:"fm_ticket",     role:["client"], label:"Ticket cockpit",  sub:"Raise & track jobs",          gate:"open", pill:"LIVE BETA" },
        { id:"fm_escrow",     role:["client"], label:"Escrow wallet",   sub:"Deposit buffer & ledger",     gate:"open" },
        { id:"fm_assets",     role:["client"], label:"Asset registry",  sub:"Sites + PLC alerts",          gate:"open" },
        { id:"fm_pools",      role:["client"], label:"Engineer pools",  sub:"Favourites + in-house",       gate:"open" },

        // DAO
        { id:"dao_queue",     role:["dao"], label:"DAO review queue", sub:"Approve engineers",          gate:"open" },
        { id:"dao_escrow",    role:["dao"], label:"Escrow oversight", sub:"Audit releases/refunds",     gate:"open" },
        { id:"dao_kpis",      role:["dao"], label:"Network KPIs",     sub:"Demand + SLA insights",      gate:"open", pill:"LIVE BETA" },
        { id:"dao_partner",   role:["dao"], label:"Partner API",      sub:"Keys, scopes, audit trail",  gate:"open" },

        // Shared narrative
        { id:"story_value",   role:["engineer","client","dao"], label:"Why Notfall",     sub:"Simple, scalable, profitable", gate:"open" },
        { id:"demo_analytics",role:["engineer","client","dao"], label:"Demo analytics", sub:"Usage + engagement",            gate:"open" },
        { id:"demo_profile",  role:["engineer","client","dao"], label:"Demographics",  sub:"Non-identifying demo profile",  gate:"open" },
      ];
      const widgetsForRole = (role) => WIDGETS.filter(w => w.role.includes(role));

      // Toasts
      function useToasts() {
        const [toasts, setToasts] = useState([]);
        const push = (title, body, meta="") => {
          const id = `${Date.now()}_${Math.random().toString(16).slice(2)}`;
          setToasts(prev => [{ id, title, body, meta, at: new Date().toISOString() }, ...prev].slice(0, 4));
          setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), 5200);
        };
        return { toasts, push };
      }

      function ToastStack({ toasts }) {
        if (!toasts?.length) return null;
        return (
          <div className="nf-toast-wrap">
            {toasts.map(t => (
              <div key={t.id} className="nf-toast">
                <div className="t1">{t.title}</div>
                <div className="t2">{t.body}</div>
                <div className="t3">{t.meta ? t.meta : timeAgo(t.at)}</div>
              </div>
            ))}
          </div>
        );
      }

      // Demographics modal (kept exactly warm + consistent font sizes)
      function DemographicsModal({ open, onClose }) {
        const [draft, setDraft] = useState({
          roleType: "Engineer",
          orgType: "Independent",
          region: "London",
          experienceBand: "5-10 years",
          tradeBand: "HVAC",
          languagePref: "English (UK)",
          deviceContext: "Desktop",
        });

        useEffect(() => {
          if (!open) return;
          Promise.resolve(api.getDemographics ? api.getDemographics() : null).then((p) => {
            if (p) setDraft((d) => ({ ...d, ...p }));
          });
        }, [open]);

        if (!open) return null;

        function save() {
          api.setDemographics && api.setDemographics(draft);
          api.track && api.track("demographics_saved", { draft });
          onClose && onClose();
        }

        return (
          <div className="nf-modal-overlay">
            <div className="nf-modal">
              <div className="flex items-start justify-between gap-3">
                <div>
                  <div className="nf-modal-title">Demo profile (demographics)</div>
                  <div className="nf-modal-sub">Aggregated demo insights only. No personal identifiers.</div>
                </div>
                <button className="nf-appbar-btn" onClick={onClose}>Close</button>
              </div>

              <div className="nf-divider"></div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                {[
                  ["Role type", "roleType", ["Engineer","Client/FM","DAO","Investor/Observer"]],
                  ["Organisation type", "orgType", ["Independent","SME","Enterprise FM","Landlord / Domestic","Industrial/OEM"]],
                  ["Region", "region", ["London","South East","Midlands","North","Scotland","Wales","Northern Ireland","International"]],
                  ["Experience band", "experienceBand", ["0-2 years","2-5 years","5-10 years","10-15 years","15+ years"]],
                  ["Trade band", "tradeBand", ["HVAC","Electrical","Fire & Safety","Lift","Plumbing","BMS","Industrial / PLC"]],
                  ["Language", "languagePref", ["English (UK)","French","Romanian","German","Other"]],
                  ["Device", "deviceContext", ["Desktop","Mobile","Tablet"]],
                ].map(([label, key, opts]) => (
                  <div key={key}>
                    <div className="text-[11px] text-slate-300 mb-1">{label}</div>
                    <select
                      className="nf-input text-[12px]"
                      value={draft[key]}
                      onChange={(e) => setDraft((p) => ({ ...p, [key]: e.target.value }))}
                    >
                      {opts.map((o) => <option key={o}>{o}</option>)}
                    </select>
                  </div>
                ))}
              </div>

              <div className="nf-modal-footer">
                <div className="text-[11px] text-slate-400">
                  Improves insights: adoption friction, workforce demand, feature engagement.
                </div>
                <div className="flex items-center gap-2">
                  <button className="nf-btn-ghost" onClick={onClose}>Cancel</button>
                  <button className="nf-btn-primary" onClick={save}>Save profile</button>
                </div>
              </div>
            </div>
          </div>
        );
      }
      function EngineerProfile({ toast }) {
        const [saving, setSaving] = useState(false);
        const [form, setForm] = useState({
          engineerId: "eng_demo",
          fullName: "Demo Engineer",
          country: "United Kingdom",
          language: "English (UK)",
          hourlyRateGBP: 65,
          tradePrimary: "HVAC",
          bio: "Emergency response engineer (demo).",
        });

        useEffect(() => {
          (async () => {
            try {
              api.startFeature && api.startFeature("eng_profile");
              const p = api.getEngineerProfile ? await api.getEngineerProfile() : null;
              if (p) setForm(prev => ({ ...prev, ...p }));
              api.endFeature && api.endFeature("eng_profile");
              api.track && api.track("widget_opened", { widget: "eng_profile" });
            } catch {}
          })();
        }, []);

        async function save() {
          setSaving(true);
          try {
            api.track && api.track("profile_save_clicked", {});
            const res = api.saveEngineerProfile ? await api.saveEngineerProfile(form) : null;
            setForm(p => ({ ...p, ...(res || {}) }));
            toast && toast("Profile saved", "Your profile is now in the demo registry.", `engineerId=${form.engineerId}`);
          } catch {
            toast && toast("Save failed", "Could not save profile (demo).", "Try again");
          } finally {
            setSaving(false);
          }
        }

        async function quickAdd(kind) {
          try {
            if (kind === "cert" && api.addCertification) await api.addCertification({});
            if (kind === "dbs" && api.addDBS) await api.addDBS({});
            if (kind === "ins" && api.addInsurance) await api.addInsurance({});
            toast && toast("Upload added", "Demo helper added an upload record.", kind);
          } catch {}
        }

        return (
          <div className="space-y-3">
            <div className="flex items-start justify-between gap-2">
              <div>
                <div className="text-[12px] uppercase tracking-[0.18em] text-slate-300">Engineer profile</div>
                <div className="text-[11px] text-slate-400">Rates, trade, compliance metadata (demo).</div>
              </div>
              <span className="nf-pill nf-pill-beta">LIVE BETA</span>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
              <div>
                <div className="text-[11px] text-slate-300 mb-1">Full name</div>
                <input className="nf-input text-[12px]" value={form.fullName} onChange={(e)=>setForm(p=>({...p, fullName:e.target.value}))}/>
              </div>
              <div>
                <div className="text-[11px] text-slate-300 mb-1">Engineer ID</div>
                <input
                  className="nf-input text-[12px]"
                  value={form.engineerId}
                  onChange={(e)=>setForm(p=>({...p, engineerId:e.target.value}))}
                  onBlur={()=>api.setEngineerId && api.setEngineerId(form.engineerId)}
                />
              </div>
              <div>
                <div className="text-[11px] text-slate-300 mb-1">Primary trade</div>
                <select className="nf-input text-[12px]" value={form.tradePrimary} onChange={(e)=>setForm(p=>({...p, tradePrimary:e.target.value}))}>
                  <option>HVAC</option><option>Electrical</option><option>Fire & Safety</option><option>Lift</option>
                  <option>Plumbing</option><option>BMS</option><option>Industrial / PLC</option>
                </select>
              </div>
              <div>
                <div className="text-[11px] text-slate-300 mb-1">Hourly rate (GBP)</div>
                <input className="nf-input text-[12px]" type="number" min="0" value={form.hourlyRateGBP}
                  onChange={(e)=>setForm(p=>({...p, hourlyRateGBP:Number(e.target.value||0)}))}
                />
              </div>
            </div>

            <div>
              <div className="text-[11px] text-slate-300 mb-1">Bio</div>
              <textarea className="nf-input text-[12px]" value={form.bio} onChange={(e)=>setForm(p=>({...p, bio:e.target.value}))}/>
            </div>

            <div className="flex items-center justify-between gap-2 flex-wrap">
              <button className="nf-btn-primary" disabled={saving} onClick={save}>{saving ? "Saving..." : "Save profile"}</button>
              <div className="flex items-center gap-2">
                <button className="nf-btn-ghost text-[12px]" onClick={()=>quickAdd("cert")}>+ Certification</button>
                <button className="nf-btn-ghost text-[12px]" onClick={()=>quickAdd("dbs")}>+ DBS</button>
                <button className="nf-btn-ghost text-[12px]" onClick={()=>quickAdd("ins")}>+ Insurance</button>
              </div>
            </div>

            <div className="text-[10px] text-slate-500">
              Tip: add insurance + at least one certification before submitting to DAO.
            </div>
          </div>
        );
      }

      function EngineerDaoStatus({ onApproved, toast }) {
        const [status, setStatus] = useState(null);
        const [loading, setLoading] = useState(false);

        async function refresh() {
          setLoading(true);
          try {
            const s = api.getDAOStatus ? await api.getDAOStatus() : null;
            setStatus(s || null);
          } catch {} finally { setLoading(false); }
        }
        useEffect(() => { refresh(); }, []);

        useDemoBus((raw) => {
          const { topic, action, payload } = readMsg(raw);
          if (topic !== "dao") return;
          if (["approved","rejected","updated","submitted","resubmitted"].includes(action)) {
            refresh();
            if (action === "approved") {
              onApproved && onApproved(true);
              toast && toast("DAO approved", "Digital ID unlocked.", payload?.engineerId || "");
            }
          }
        });

        async function submit() {
          setLoading(true);
          try {
            const r = api.submitProfileToDAO ? await api.submitProfileToDAO() : null;
            toast && toast("Submitted", "Profile added to DAO queue (demo).", String(r?.status || "PENDING"));
            await refresh();
          } finally { setLoading(false); }
        }
        async function resubmit() {
          setLoading(true);
          try {
            const r = api.resubmitDAO ? await api.resubmitDAO() : null;
            toast && toast("Resubmitted", "Profile resubmitted for DAO review (demo).", String(r?.status || "PENDING"));
            await refresh();
          } finally { setLoading(false); }
        }

        const raw = String(status?.status || status?.state || "NOT_SUBMITTED").toUpperCase();
        const badge =
          raw === "APPROVED_CERTIFIED" ? "APPROVED_CERTIFIED" :
          raw === "APPROVED" ? "APPROVED" :
          (raw === "PENDING" || raw === "IN_REVIEW") ? "PENDING" :
          raw === "REJECTED" ? "REJECTED" : "NOT_SUBMITTED";

        return (
          <div className="space-y-3">
            <div className="flex items-start justify-between gap-2">
              <div>
                <div className="text-[12px] uppercase tracking-[0.18em] text-slate-300">DAO approval status</div>
                <div className="text-[11px] text-slate-400">Certification gateway for trust & compliance.</div>
              </div>
              <button className="nf-appbar-btn" onClick={refresh}>{loading ? "..." : "Refresh"}</button>
            </div>

            <div className="rounded-3xl border border-white/10 bg-white/5 p-4">
              <div className="flex items-center justify-between gap-2">
                <div className="text-[12px] font-extrabold text-slate-100">Status</div>
                <StatusBadge status={badge}/>
              </div>
              <div className="text-[11px] text-slate-400 mt-2">{status?.note || status?.message || "No notes yet."}</div>

              <div className="mt-3 flex items-center gap-2 flex-wrap">
                {badge === "NOT_SUBMITTED" && <button className="nf-btn-primary" onClick={submit}>Submit for review</button>}
                {badge === "REJECTED" && <button className="nf-btn-primary" onClick={resubmit}>Resubmit</button>}
                {(badge === "APPROVED" || badge === "APPROVED_CERTIFIED") && <span className="nf-pill">✅ Digital ID unlocked</span>}
              </div>
            </div>
          </div>
        );
      }

      function EngineerTaskInbox({ toast }) {
        const [tasks, setTasks] = useState([]);
        const [loading, setLoading] = useState(false);
        const [lastOfferAt, setLastOfferAt] = useState(null);

        function normaliseTask(t) {
          const _id = t?._id || t?.id || t?.taskId || t?.offerId;
          return { ...t, _id };
        }

        useDemoBus((raw) => {
          const { topic, action, payload } = readMsg(raw);
          if (topic !== "task") return;

          if (action === "offer") {
            const offer = payload;
            setLastOfferAt(new Date().toISOString());
            setTasks(prev => [normaliseTask(offer), ...(prev || [])]);
            playOfferSound(); vibrate();
            toast && toast("New task offer", offer?.summary || "Offer received", offer?.ticketId ? `ticketId=${offer.ticketId}` : "");
            api.track && api.track("task_offer_received", { offerId: offer?.id || offer?._id });
          }

          if (action === "update") {
            const up = payload;
            setTasks(prev => (prev || []).map(t => ((t._id || t.id) === (up._id || up.id) ? normaliseTask({ ...t, ...up }) : t)));
          }
        });

        async function load() {
          setLoading(true);
          try {
            api.startFeature && api.startFeature("eng_inbox");
            const data = api.getTasks ? await api.getTasks() : [];
            setTasks((data || []).map(normaliseTask));
            api.endFeature && api.endFeature("eng_inbox");
          } catch {} finally { setLoading(false); }
        }
        useEffect(() => { load(); }, []);

        async function act(action, id) {
          if (!id) return;
          try {
            api.track && api.track("task_action", { action, id });
            if (action === "accept" && api.acceptTask) await api.acceptTask(id);
            if (action === "decline" && api.declineTask) await api.declineTask(id);
            if (action === "travel" && api.startTravel) await api.startTravel(id);
            if (action === "arrive" && api.arriveOnSite) await api.arriveOnSite(id);
            if (action === "requestComplete" && api.requestComplete) await api.requestComplete(id, {});
            await load();
          } catch {}
        }

        return (
          <div className="space-y-3">
            <div className="flex items-start justify-between gap-2 flex-wrap">
              <div>
                <div className="text-[12px] uppercase tracking-[0.18em] text-slate-300">Task inbox</div>
                <div className="text-[11px] text-slate-400">Live offers + accept/decline workflow.</div>
              </div>
              <div className="flex items-center gap-2">
                <span className="nf-pill">Listening{lastOfferAt ? ` • ${timeAgo(lastOfferAt)}` : ""}</span>
                <button className="nf-appbar-btn" onClick={load}>{loading ? "..." : "Refresh"}</button>
              </div>
            </div>

            {tasks.length === 0 ? (
              <div className="rounded-3xl border border-white/10 bg-white/5 p-4 text-[11px] text-slate-400">
                No tasks yet. Switch to <b>Client/FM</b> and create a ticket to generate offers.
              </div>
            ) : (
              <div className="space-y-2 max-h-[520px] overflow-y-auto pr-1">
                {tasks.map((t) => {
                  const id = t._id || t.id;
                  return (
                    <div key={id} className="rounded-3xl border border-sky-400/25 bg-white/5 p-4">
                      <div className="flex items-center justify-between gap-2">
                        <div className="text-[13px] font-extrabold text-slate-100">{t.summary || t.title || "Task"}</div>
                        <StatusBadge status={String(t.status || "NEW").toUpperCase()} />
                      </div>
                      <div className="text-[11px] text-slate-400 mt-1">
                        {t.site || t.location?.label || "Level39"} • {t.trade || "HVAC"} • {t.priority || "HIGH"}
                      </div>
                      <div className="mt-3 flex items-center gap-2 flex-wrap">
                        <button className="nf-btn-primary text-[12px]" onClick={()=>act("accept", id)}>Accept</button>
                        <button className="nf-btn-ghost text-[12px]" onClick={()=>act("decline", id)}>Decline</button>
                        <button className="nf-btn-ghost text-[12px]" onClick={()=>act("travel", id)}>Start travel</button>
                        <button className="nf-btn-ghost text-[12px]" onClick={()=>act("arrive", id)}>Arrive</button>
                        <button className="nf-btn-ghost text-[12px]" onClick={()=>act("requestComplete", id)}>Request complete</button>
                      </div>
                      <div className="text-[10px] text-slate-500 mt-3">
                        Completion requires evidence (before + after + notes) in the Evidence vault.
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        );
      }

      function EngineerEvidenceVault({ toast }) {
        const [tasks, setTasks] = useState([]);
        const [selectedId, setSelectedId] = useState("");
        const [draft, setDraft] = useState({ beforePhotos: [], afterPhotos: [], notes: "", labourMins: 60, materials: [] });
        const [busy, setBusy] = useState(false);

        async function load() {
          const data = api.getTasks ? await api.getTasks() : [];
          setTasks(Array.isArray(data) ? data : []);
          if (!selectedId && data?.[0]) setSelectedId(data[0]._id || data[0].id);
        }
        useEffect(() => { load(); }, []);

        const selected = useMemo(() => tasks.find(t => (t._id || t.id) === selectedId) || null, [tasks, selectedId]);

        function onFiles(files, key) {
          const list = Array.from(files || []);
          Promise.all(list.map(f => new Promise((res) => {
            const r = new FileReader();
            r.onload = () => res(String(r.result || ""));
            r.readAsDataURL(f);
          }))).then(urls => {
            setDraft(d => ({ ...d, [key]: [...(d[key] || []), ...urls].slice(0, 6) }));
          });
        }

        async function submit() {
          if (!selectedId) return;
          setBusy(true);
          try {
            await (api.submitEvidence ? api.submitEvidence(selectedId, draft) : Promise.resolve());
            toast && toast("Evidence submitted", "Before/after + notes saved to the task.", `taskId=${selectedId}`);
            await load();
          } finally { setBusy(false); }
        }

        async function complete() {
          if (!selectedId) return;
          setBusy(true);
          try {
            const r = api.completeTask ? await api.completeTask(selectedId, {}) : null;
            if (r?.error) {
              toast && toast("Cannot complete", r.error, "Add missing evidence");
            } else {
              toast && toast("Task completed", "Escrow buffer released (demo).", `taskId=${selectedId}`);
            }
            await load();
          } finally { setBusy(false); }
        }

        return (
          <div className="space-y-3">
            <div className="flex items-start justify-between gap-2 flex-wrap">
              <div>
                <div className="text-[12px] uppercase tracking-[0.18em] text-slate-300">Evidence vault</div>
                <div className="text-[11px] text-slate-400">Evidence-gated completion (before/after + notes).</div>
              </div>
              <button className="nf-appbar-btn" onClick={load}>Refresh</button>
            </div>

            <div className="rounded-3xl border border-white/10 bg-white/5 p-4 space-y-3">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                <div>
                  <div className="text-[11px] text-slate-300 mb-1">Select task</div>
                  <select className="nf-input text-[12px]" value={selectedId} onChange={(e)=>setSelectedId(e.target.value)}>
                    {(tasks || []).map(t => (
                      <option key={t._id || t.id} value={t._id || t.id}>
                        {(t.summary || "Task")} • {(t.status || "NEW")}
                      </option>
                    ))}
                  </select>
                </div>
                <div className="text-[11px] text-slate-400 flex items-end">
                  {selected ? <>ticketId: <span className="font-mono ml-2 text-slate-200">{selected.ticketId || "—"}</span></> : "—"}
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                  <div className="text-[11px] text-slate-300 mb-1">Before photos</div>
                  <input className="nf-input text-[12px]" type="file" multiple accept="image/*" onChange={(e)=>onFiles(e.target.files, "beforePhotos")} />
                  <div className="text-[10px] text-slate-500 mt-1">{(draft.beforePhotos || []).length} attached</div>
                </div>
                <div>
                  <div className="text-[11px] text-slate-300 mb-1">After photos</div>
                  <input className="nf-input text-[12px]" type="file" multiple accept="image/*" onChange={(e)=>onFiles(e.target.files, "afterPhotos")} />
                  <div className="text-[10px] text-slate-500 mt-1">{(draft.afterPhotos || []).length} attached</div>
                </div>
              </div>

              <div>
                <div className="text-[11px] text-slate-300 mb-1">Completion notes</div>
                <textarea className="nf-input text-[12px]" value={draft.notes} onChange={(e)=>setDraft(d=>({...d, notes:e.target.value}))}/>
                <div className="text-[10px] text-slate-500 mt-1">Minimum note length enforced by FakeAPI.</div>
              </div>

              <div className="flex items-center gap-2 flex-wrap">
                <button className="nf-btn-primary" disabled={busy} onClick={submit}>{busy ? "..." : "Submit evidence"}</button>
                <button className="nf-btn-ghost" disabled={busy} onClick={complete}>Complete task</button>
              </div>
            </div>
          </div>
        );
      }

      async function exportEngineerIdCardPng(profile) {
        const width = 1024, height = 640;
        const canvas = document.createElement("canvas");
        canvas.width = width; canvas.height = height;
        const ctx = canvas.getContext("2d");

        const grd = ctx.createLinearGradient(0, 0, width, height);
        grd.addColorStop(0, "#020617"); grd.addColorStop(1, "#0b1227");
        ctx.fillStyle = grd; ctx.fillRect(0, 0, width, height);

        ctx.strokeStyle = "#38bdf8"; ctx.lineWidth = 6;
        ctx.strokeRect(20, 20, width - 40, height - 40);

        ctx.fillStyle = "#e5e7eb"; ctx.font = "700 32px system-ui";
        ctx.fillText("NOTFALL ENGINEERS — DIGITAL ID", 60, 80);

        ctx.fillStyle = "#f87171"; ctx.font = "700 18px system-ui";
        ctx.fillText("LIVE BETA", width - 180, 80);

        ctx.fillStyle = "#e5e7eb"; ctx.font = "800 30px system-ui";
        ctx.fillText(profile?.fullName || "Engineer", 60, 150);

        ctx.font = "16px system-ui"; ctx.fillStyle = "#cbd5f5";
        ctx.fillText(`Engineer ID: ${profile?.engineerId || "eng_demo"}`, 60, 200);
        ctx.fillText(`Trade: ${profile?.tradePrimary || "HVAC"}`, 60, 230);
        ctx.fillText(`Rate: £${profile?.hourlyRateGBP || 65}/hr`, 60, 260);

        ctx.fillStyle = "#22c55e"; ctx.font = "900 18px system-ui";
        ctx.fillText("DAO CERTIFIED ENGINEER", 60, 320);

        ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, monospace";
        ctx.fillStyle = "#94a3b8";
        ctx.fillText(`Issued ${new Date().toISOString().slice(0, 10)} • Level39 Demo`, 60, height - 60);

        const url = canvas.toDataURL("image/png");
        const a = document.createElement("a");
        a.href = url;
        a.download = `Notfall_Engineer_ID_${profile?.engineerId || "eng_demo"}.png`;
        a.click();
      }

      function EngineerIdCard({ daoApproved, toast }) {
        const [profile, setProfile] = useState(null);

        useEffect(() => {
          (async () => {
            const p = api.getEngineerProfile ? await api.getEngineerProfile() : null;
            setProfile(p || null);
            api.track && api.track("widget_opened", { widget: "eng_id" });
          })();
        }, []);

        if (!daoApproved) {
          return (
            <div className="rounded-3xl border border-white/10 bg-white/5 p-4">
              <div className="text-[12px] font-extrabold text-slate-100">Digital ID card</div>
              <div className="text-[11px] text-slate-400 mt-2">
                Locked until DAO approval. Submit your profile and approve via the DAO queue.
              </div>
              <div className="mt-3"><StatusBadge status="LOCKED" /></div>
            </div>
          );
        }

        return (
          <div className="rounded-3xl border border-sky-400/25 bg-white/5 overflow-hidden">
            <div className="px-4 py-3 bg-black/25 border-b border-white/10">
              <div className="flex items-center justify-between">
                <div className="text-[11px] uppercase tracking-[0.22em] text-slate-200 font-extrabold">NOTFALL • DIGITAL ID</div>
                <div className="text-[10px] text-red-400 font-extrabold uppercase tracking-[0.16em]">LIVE BETA</div>
              </div>
              <div className="text-[11px] text-slate-400 mt-1">DAO certified engineer credential</div>
            </div>

            <div className="p-4">
              <div className="text-[16px] font-extrabold text-slate-100">{profile?.fullName || "Demo Engineer"}</div>
              <div className="text-[11px] text-slate-400 font-mono mt-1">
                engineerId: {profile?.engineerId || "eng_demo"} • trade: {profile?.tradePrimary || "HVAC"} • rate: £{profile?.hourlyRateGBP || 65}/hr
              </div>

              <div className="mt-4 flex items-center justify-between gap-2">
                <span className="nf-pill">✅ DAO APPROVED</span>
                <button className="nf-btn-primary text-[12px]" onClick={()=>{
                  exportEngineerIdCardPng(profile || {});
                  toast && toast("Downloaded", "Digital ID exported as PNG.", profile?.engineerId || "");
                }}>Download PNG</button>
              </div>
            </div>
          </div>
        );
      }
      function ClientTicketCockpit({ toast }) {
        const [tickets, setTickets] = useState([]);
        const [loading, setLoading] = useState(false);
        const [form, setForm] = useState({
          site: "Level39 — 1 Canada Square",
          siteCode: "L39",
          summary: "Emergency boiler leak — reception zone",
          description: "Auto-generated ticket from demo cockpit.",
          priority: "HIGH",
          trade: "HVAC",
          depositAmountGBP: 200,
          source: "Manual",
        });

        useDemoBus((raw) => {
          const { topic, action, payload } = readMsg(raw);
          if (topic === "ticket" && (action === "created" || action === "updated")) {
            setTickets(prev => {
              const id = payload.ticketId || payload.id;
              const map = new Map((prev || []).map(x => [(x.ticketId||x.id), x]));
              map.set(id, payload);
              return Array.from(map.values()).sort((a,b)=> new Date(b.createdAt||b.updatedAt||0)-new Date(a.createdAt||a.updatedAt||0)).slice(0, 80);
            });
          }
          if (topic === "task" && action === "offer") {
            toast && toast("Dispatch sent", "Offer created from ticket (demo).", payload?.ticketId || "");
          }
        });

        async function refresh() {
          setLoading(true);
          try {
            const t = api.getClientTickets ? await api.getClientTickets() : [];
            setTickets(Array.isArray(t) ? t : []);
          } catch {} finally { setLoading(false); }
        }
        useEffect(() => { refresh(); }, []);

        async function create() {
          setLoading(true);
          try {
            api.track && api.track("ticket_create_clicked", { trade: form.trade, priority: form.priority });
            const r = api.createDemoTicket ? await api.createDemoTicket(form) : null;
            toast && toast("Ticket created", "Escrow deposit mirrored (if deposit > 0).", r?.ticketId || "");
            await refresh();
          } finally { setLoading(false); }
        }

        return (
          <div className="space-y-3">
            <div className="flex items-start justify-between gap-2">
              <div>
                <div className="text-[12px] uppercase tracking-[0.18em] text-slate-300">Ticket cockpit</div>
                <div className="text-[11px] text-slate-400">Create tickets that mirror escrow deposits (buffer).</div>
              </div>
              <span className="nf-pill nf-pill-beta">LIVE BETA</span>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
              <div>
                <div className="text-[11px] text-slate-300 mb-1">Site</div>
                <input className="nf-input text-[12px]" value={form.site} onChange={(e)=>setForm(p=>({...p, site:e.target.value}))}/>
              </div>
              <div>
                <div className="text-[11px] text-slate-300 mb-1">Deposit (GBP)</div>
                <input className="nf-input text-[12px]" type="number" min="0" value={form.depositAmountGBP}
                  onChange={(e)=>setForm(p=>({...p, depositAmountGBP:Number(e.target.value||0)}))}
                />
              </div>
              <div>
                <div className="text-[11px] text-slate-300 mb-1">Trade</div>
                <select className="nf-input text-[12px]" value={form.trade} onChange={(e)=>setForm(p=>({...p, trade:e.target.value}))}>
                  <option>HVAC</option><option>Electrical</option><option>Fire & Safety</option><option>Lift</option>
                  <option>Plumbing</option><option>BMS</option><option>Industrial / PLC</option>
                </select>
              </div>
              <div>
                <div className="text-[11px] text-slate-300 mb-1">Priority</div>
                <select className="nf-input text-[12px]" value={form.priority} onChange={(e)=>setForm(p=>({...p, priority:e.target.value}))}>
                  <option>LOW</option><option>MEDIUM</option><option>HIGH</option><option>CRITICAL</option><option>HARDSTOP</option>
                </select>
              </div>
            </div>

            <div>
              <div className="text-[11px] text-slate-300 mb-1">Summary</div>
              <input className="nf-input text-[12px]" value={form.summary} onChange={(e)=>setForm(p=>({...p, summary:e.target.value}))}/>
            </div>

            <div>
              <div className="text-[11px] text-slate-300 mb-1">Description</div>
              <textarea className="nf-input text-[12px]" value={form.description} onChange={(e)=>setForm(p=>({...p, description:e.target.value}))}/>
            </div>

            <div className="flex items-center justify-between gap-2">
              <button className="nf-btn-primary" onClick={create} disabled={loading}>{loading ? "Creating..." : "Create ticket"}</button>
              <button className="nf-appbar-btn" onClick={refresh}>{loading ? "..." : "Refresh"}</button>
            </div>

            <div className="rounded-3xl border border-white/10 bg-white/5 p-4">
              <div className="flex items-center justify-between">
                <div className="text-[12px] font-extrabold text-slate-100">Tickets</div>
                <span className="nf-pill">{tickets.length}</span>
              </div>
              <div className="mt-3 space-y-2 max-h-[380px] overflow-y-auto pr-1">
                {tickets.length === 0 ? (
                  <div className="text-[11px] text-slate-400">No tickets yet.</div>
                ) : (
                  tickets.map((t)=>(
                    <div key={t.ticketId || t.id} className="rounded-3xl border border-white/10 bg-black/20 p-3">
                      <div className="flex items-center justify-between">
                        <div className="text-[12px] font-extrabold text-slate-100">{t.summary || "Ticket"}</div>
                        <StatusBadge status={String(t.status || "OPEN").toUpperCase()} />
                      </div>
                      <div className="text-[11px] text-slate-400 mt-1">
                        {t.site || "—"} • {t.trade || "—"} • {t.priority || "—"} • escrow: £{t.depositAmountGBP ?? 0}
                      </div>
                    </div>
                  ))
                )}
              </div>
            </div>
          </div>
        );
      }

      function EscrowWallet({ toast }) {
        const [status, setStatus] = useState(null);
        const [ledger, setLedger] = useState([]);
        const [amount, setAmount] = useState(200);

        async function refresh() {
          const r = api.getEscrowStatus ? await api.getEscrowStatus() : null;
          setStatus(r?.status || null);
          setLedger(Array.isArray(r?.ledger) ? r.ledger : []);
        }
        useEffect(() => { refresh(); }, []);

        useDemoBus((raw) => {
          const { topic, action, payload } = readMsg(raw);
          if (topic === "escrow" && action === "update") {
            setStatus(payload?.status || null);
            if (payload?.ledgerEntry) setLedger(prev => [payload.ledgerEntry, ...(prev||[])].slice(0, 80));
            toast && toast("Escrow updated", `${payload?.ledgerEntry?.type || "update"} • £${payload?.ledgerEntry?.amountGBP ?? ""}`, payload?.ledgerEntry?.reference || "");
          }
        });

        async function deposit() {
          await (api.escrowDeposit ? api.escrowDeposit({ amountGBP: amount, reference: "NF-ESCROW-DEMO", payerLabel: "Client/FM Deposit", role: "CLIENT" }) : Promise.resolve());
        }
        async function release() {
          await (api.escrowRelease ? api.escrowRelease({ amountGBP: amount, role: "ESCROW" }) : Promise.resolve());
        }
        async function refund() {
          await (api.escrowRefund ? api.escrowRefund({ amountGBP: amount, role: "ESCROW" }) : Promise.resolve());
        }

        return (
          <div className="space-y-3">
            <div className="flex items-start justify-between gap-2">
              <div>
                <div className="text-[12px] uppercase tracking-[0.18em] text-slate-300">Escrow wallet</div>
                <div className="text-[11px] text-slate-400">Revolut-aligned buffer + ledger (demo).</div>
              </div>
              <button className="nf-appbar-btn" onClick={refresh}>Refresh</button>
            </div>

            <div className="rounded-3xl border border-white/10 bg-white/5 p-4">
              <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                <div className="rounded-3xl border border-white/10 bg-black/20 p-4">
                  <div className="text-[11px] text-slate-400">Held in escrow</div>
                  <div className="text-[22px] font-extrabold text-slate-100">£{status?.heldInEscrowGBP ?? 0}</div>
                  <div className="text-[10px] text-slate-500 mt-2">{status?.accountName || "—"}</div>
                </div>
                <div className="rounded-3xl border border-white/10 bg-black/20 p-4">
                  <div className="text-[11px] text-slate-400">Released</div>
                  <div className="text-[22px] font-extrabold text-slate-100">£{status?.releasedGBP ?? 0}</div>
                  <div className="text-[10px] text-slate-500 mt-2">ref: {status?.refPrefix || "—"}</div>
                </div>
                <div className="rounded-3xl border border-white/10 bg-black/20 p-4">
                  <div className="text-[11px] text-slate-400">Refunded</div>
                  <div className="text-[22px] font-extrabold text-slate-100">£{status?.refundedGBP ?? 0}</div>
                  <div className="text-[10px] text-slate-500 mt-2">{status?.updatedAt ? `updated ${timeAgo(status.updatedAt)}` : ""}</div>
                </div>
              </div>

              <div className="mt-4 flex items-center gap-2 flex-wrap">
                <input className="nf-input text-[12px] w-[170px]" type="number" min="0" value={amount} onChange={(e)=>setAmount(Number(e.target.value||0))}/>
                <button className="nf-btn-primary text-[12px]" onClick={deposit}>Deposit</button>
                <button className="nf-btn-ghost text-[12px]" onClick={release}>Release</button>
                <button className="nf-btn-ghost text-[12px]" onClick={refund}>Refund</button>
              </div>
            </div>

            <div className="rounded-3xl border border-white/10 bg-white/5 p-4">
              <div className="flex items-center justify-between">
                <div className="text-[12px] font-extrabold text-slate-100">Ledger</div>
                <span className="nf-pill">{ledger.length}</span>
              </div>
              <div className="mt-3 space-y-2 max-h-[360px] overflow-y-auto pr-1">
                {(ledger || []).length === 0 ? (
                  <div className="text-[11px] text-slate-400">No ledger entries yet.</div>
                ) : (
                  ledger.map(x => (
                    <div key={x.id} className="rounded-3xl border border-white/10 bg-black/20 p-3">
                      <div className="flex items-center justify-between">
                        <div className="text-[12px] font-extrabold text-slate-100">{x.type || "entry"} • £{x.amountGBP}</div>
                        <span className="nf-pill">{x.role || "—"}</span>
                      </div>
                      <div className="text-[11px] text-slate-400 mt-1">{x.reference || "—"} • {x.payerLabel || "—"} • {timeAgo(x.createdAt)}</div>
                    </div>
                  ))
                )}
              </div>
            </div>
          </div>
        );
      }

      function AssetsAndPlc({ toast }) {
        const [assets, setAssets] = useState([]);
        const [alerts, setAlerts] = useState([]);
        const [newAsset, setNewAsset] = useState({ name: "Demo Asset", siteCode:"L39", siteName:"Level39 — 1 Canada Square", category:"Plant" });

        async function refresh() {
          const a = api.getAssets ? await api.getAssets() : [];
          const p = api.getPlcAlerts ? await api.getPlcAlerts() : [];
          setAssets(Array.isArray(a) ? a : []);
          setAlerts(Array.isArray(p) ? p : []);
        }
        useEffect(() => { refresh(); }, []);

        useDemoBus((raw) => {
          const { topic, action, payload } = readMsg(raw);
          if (topic === "assetregistry" && (action === "updated" || action === "deleted")) refresh();
          if (topic === "plcalert" && action === "created") {
            toast && toast("PLC alert", payload?.message || "Alert created", payload?.code || "");
            refresh();
          }
        });

        async function addAsset() {
          const r = api.createAsset ? await api.createAsset(newAsset) : null;
          toast && toast("Asset created", r?.name || "Asset", r?.siteCode || "");
          refresh();
        }
        async function createCriticalAlert() {
          await (api.createTestPlcAlert ? api.createTestPlcAlert({
            severity: "Critical",
            message: "HardStop detected — production line halted",
            code: "HARDSTOP-001",
            siteName: "Level39 — 1 Canada Square",
            siteCode: "L39",
            plcTag: "DB1.FaultSignal"
          }) : Promise.resolve());
        }

        return (
          <div className="space-y-3">
            <div className="flex items-start justify-between gap-2">
              <div>
                <div className="text-[12px] uppercase tracking-[0.18em] text-slate-300">Asset registry</div>
                <div className="text-[11px] text-slate-400">Editable assets + PLC alerts (Critical → ticket auto-create).</div>
              </div>
              <button className="nf-appbar-btn" onClick={refresh}>Refresh</button>
            </div>

            <div className="rounded-3xl border border-white/10 bg-white/5 p-4 space-y-3">
              <div className="grid grid-cols-1 md:grid-cols-3 gap-2">
                <div>
                  <div className="text-[11px] text-slate-300 mb-1">Asset name</div>
                  <input className="nf-input text-[12px]" value={newAsset.name} onChange={(e)=>setNewAsset(p=>({...p, name:e.target.value}))}/>
                </div>
                <div>
                  <div className="text-[11px] text-slate-300 mb-1">Site code</div>
                  <input className="nf-input text-[12px]" value={newAsset.siteCode} onChange={(e)=>setNewAsset(p=>({...p, siteCode:e.target.value}))}/>
                </div>
                <div className="flex items-end gap-2">
                  <button className="nf-btn-primary text-[12px]" onClick={addAsset}>Add asset</button>
                  <button className="nf-btn-ghost text-[12px]" onClick={createCriticalAlert}>Create Critical PLC alert</button>
                </div>
              </div>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-3">
              <div className="rounded-3xl border border-white/10 bg-white/5 p-4">
                <div className="flex items-center justify-between">
                  <div className="text-[12px] font-extrabold text-slate-100">Assets</div>
                  <span className="nf-pill">{assets.length}</span>
                </div>
                <div className="mt-3 space-y-2 max-h-[360px] overflow-y-auto pr-1">
                  {(assets || []).length === 0 ? <div className="text-[11px] text-slate-400">No assets yet.</div> : assets.map(a => (
                    <div key={a.id || a._id} className="rounded-3xl border border-white/10 bg-black/20 p-3">
                      <div className="text-[12px] font-extrabold text-slate-100">{a.name}</div>
                      <div className="text-[11px] text-slate-400 mt-1">{a.siteCode} • {a.category || "—"} • {timeAgo(a.updatedAt || a.createdAt)}</div>
                    </div>
                  ))}
                </div>
              </div>

              <div className="rounded-3xl border border-white/10 bg-white/5 p-4">
                <div className="flex items-center justify-between">
                  <div className="text-[12px] font-extrabold text-slate-100">PLC alerts</div>
                  <span className="nf-pill">{alerts.length}</span>
                </div>
                <div className="mt-3 space-y-2 max-h-[360px] overflow-y-auto pr-1">
                  {(alerts || []).length === 0 ? <div className="text-[11px] text-slate-400">No alerts yet.</div> : alerts.map(a => (
                    <div key={a.id || a._id} className="rounded-3xl border border-white/10 bg-black/20 p-3">
                      <div className="flex items-center justify-between">
                        <div className="text-[12px] font-extrabold text-slate-100">{a.code || "ALERT"} • {a.severity}</div>
                        <span className="nf-pill">{a.siteCode || "—"}</span>
                      </div>
                      <div className="text-[11px] text-slate-400 mt-1">{a.message || "—"} • tag: {a.plcTag || "—"}</div>
                      <div className="text-[10px] text-slate-500 mt-2">{timeAgo(a.createdAt)}</div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          </div>
        );
      }

      function EngineerPools({ toast }) {
        const [pools, setPools] = useState({ favourites: [], inHouse: [], notfallPool: [] });
        const [name, setName] = useState("A. Patel");

        async function refresh() {
          const p = api.getEngineerPools ? await api.getEngineerPools() : null;
          setPools(p || { favourites: [], inHouse: [], notfallPool: [] });
        }
        useEffect(() => { refresh(); }, []);

        useDemoBus((raw) => {
          const { topic, action, payload } = readMsg(raw);
          if (topic === "engineerpools" && action === "updated") setPools(payload || pools);
        });

        async function addFavourite() {
          const rec = { engineerId: `fav_${Date.now()}`, fullName: name, tradePrimary: "HVAC", rating: 4.8, daoStatus: "APPROVED_CERTIFIED" };
          api.addFavouriteEngineer && api.addFavouriteEngineer(rec);
          toast && toast("Favourite added", rec.fullName, rec.engineerId);
          refresh();
        }

        async function addInHouse() {
          const rec = { engineerId: `ih_${Date.now()}`, fullName: name, tradePrimary: "HVAC", daoStatus: "NOT_DAO_CERTIFIED" };
          api.addInHouseEngineer && api.addInHouseEngineer(rec);
          toast && toast("In-house added", rec.fullName, rec.engineerId);
          refresh();
        }

        return (
          <div className="space-y-3">
            <div className="flex items-start justify-between gap-2">
              <div>
                <div className="text-[12px] uppercase tracking-[0.18em] text-slate-300">Engineer pools</div>
                <div className="text-[11px] text-slate-400">Favourites, in-house, and network lists (demo).</div>
              </div>
              <button className="nf-appbar-btn" onClick={refresh}>Refresh</button>
            </div>

            <div className="rounded-3xl border border-white/10 bg-white/5 p-4">
              <div className="grid grid-cols-1 md:grid-cols-3 gap-2 items-end">
                <div className="md:col-span-2">
                  <div className="text-[11px] text-slate-300 mb-1">Engineer name</div>
                  <input className="nf-input text-[12px]" value={name} onChange={(e)=>setName(e.target.value)} />
                </div>
                <div className="flex items-center gap-2">
                  <button className="nf-btn-primary text-[12px]" onClick={addFavourite}>Add favourite</button>
                  <button className="nf-btn-ghost text-[12px]" onClick={addInHouse}>Add in-house</button>
                </div>
              </div>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-3">
              {[
                ["Favourites", pools.favourites || []],
                ["In-house", pools.inHouse || []],
              ].map(([label, list]) => (
                <div key={label} className="rounded-3xl border border-white/10 bg-white/5 p-4">
                  <div className="flex items-center justify-between">
                    <div className="text-[12px] font-extrabold text-slate-100">{label}</div>
                    <span className="nf-pill">{list.length}</span>
                  </div>
                  <div className="mt-3 space-y-2 max-h-[360px] overflow-y-auto pr-1">
                    {list.length === 0 ? <div className="text-[11px] text-slate-400">No entries.</div> : list.map(x => (
                      <div key={x.engineerId || x.id} className="rounded-3xl border border-white/10 bg-black/20 p-3">
                        <div className="flex items-center justify-between">
                          <div className="text-[12px] font-extrabold text-slate-100">{x.fullName || "Engineer"}</div>
                          <span className="nf-pill">{x.daoStatus || "—"}</span>
                        </div>
                        <div className="text-[11px] text-slate-400 mt-1">{x.tradePrimary || "—"} • {x.engineerId || "—"}</div>
                      </div>
                    ))}
                  </div>
                </div>
              ))}
            </div>
          </div>
        );
      }

      function DaoReviewQueue({ onApproved, toast }) {
        const [items, setItems] = useState([]);
        const [loading, setLoading] = useState(false);

        async function refresh() {
          setLoading(true);
          try {
            const q = api.getDaoQueue ? await api.getDaoQueue() : [];
            setItems(Array.isArray(q) ? q : []);
          } catch {} finally { setLoading(false); }
        }
        useEffect(() => { refresh(); }, []);

        async function approve(engineerId) {
          setLoading(true);
          try {
            await (api.approveDaoEngineer ? api.approveDaoEngineer(engineerId, "Approved (demo)") : Promise.resolve());
            onApproved && onApproved(true);
            toast && toast("Approved", "Engineer DAO status is now APPROVED_CERTIFIED.", engineerId);
            await refresh();
          } finally { setLoading(false); }
        }
        async function reject(engineerId) {
          setLoading(true);
          try {
            await (api.rejectDaoEngineer ? api.rejectDaoEngineer(engineerId, "Rejected (demo)") : Promise.resolve());
            toast && toast("Rejected", "Engineer DAO status is now REJECTED.", engineerId);
            await refresh();
          } finally { setLoading(false); }
        }

        return (
          <div className="space-y-3">
            <div className="flex items-start justify-between gap-2">
              <div>
                <div className="text-[12px] uppercase tracking-[0.18em] text-slate-300">DAO review queue</div>
                <div className="text-[11px] text-slate-400">Approve engineers → unlock credentials.</div>
              </div>
              <button className="nf-appbar-btn" onClick={refresh}>{loading ? "..." : "Refresh"}</button>
            </div>

            <div className="rounded-3xl border border-white/10 bg-white/5 p-4">
              <div className="flex items-center justify-between">
                <div className="text-[12px] font-extrabold text-slate-100">Pending engineers</div>
                <span className="nf-pill">{items.length}</span>
              </div>
              <div className="mt-3 space-y-2 max-h-[520px] overflow-y-auto pr-1">
                {items.length === 0 ? (
                  <div className="text-[11px] text-slate-400">Queue empty.</div>
                ) : (
                  items.map((x)=>(
                    <div key={x.engineerId || x._id || Math.random()} className="rounded-3xl border border-white/10 bg-black/20 p-3">
                      <div className="flex items-center justify-between">
                        <div className="text-[12px] font-extrabold text-slate-100">
                          {x.fullName || "Engineer"} <span className="text-slate-400 font-mono text-[10px]">({x.engineerId || "—"})</span>
                        </div>
                        <StatusBadge status={String(x.status || "PENDING").toUpperCase()} />
                      </div>
                      <div className="text-[11px] text-slate-400 mt-1">{x.tradePrimary || "—"} • {x.country || "—"}</div>
                      <div className="mt-3 flex items-center gap-2">
                        <button className="nf-btn-primary text-[12px]" onClick={()=>approve(x.engineerId)} disabled={loading}>Approve</button>
                        <button className="nf-btn-ghost text-[12px]" onClick={()=>reject(x.engineerId)} disabled={loading}>Reject</button>
                      </div>
                    </div>
                  ))
                )}
              </div>
            </div>
          </div>
        );
      }

      function DaoKpis() {
        const [summary, setSummary] = useState(null);

        useEffect(() => {
          (async () => {
            const s = api.getTaskHistorySummary ? await api.getTaskHistorySummary() : null;
            setSummary(s || null);
          })();
        }, []);

        return (
          <div className="space-y-3">
            <div className="flex items-start justify-between gap-2">
              <div>
                <div className="text-[12px] uppercase tracking-[0.18em] text-slate-300">Network KPIs</div>
                <div className="text-[11px] text-slate-400">Investable signals: speed, throughput, escrow discipline.</div>
              </div>
              <span className="nf-pill nf-pill-beta">LIVE BETA</span>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-3">
              <div className="rounded-3xl border border-white/10 bg-white/5 p-4">
                <div className="text-[11px] text-slate-400">Completed tasks</div>
                <div className="text-[22px] font-extrabold text-slate-100 mt-1">{summary?.totalCompleted ?? 0}</div>
                <div className="text-[11px] text-slate-400 mt-2">Evidence-gated completion.</div>
              </div>
              <div className="rounded-3xl border border-white/10 bg-white/5 p-4">
                <div className="text-[11px] text-slate-400">Avg completion (mins)</div>
                <div className="text-[22px] font-extrabold text-slate-100 mt-1">{summary?.avgMinsOverall ?? 0}</div>
                <div className="text-[11px] text-slate-400 mt-2">Fast response improves retention.</div>
              </div>
              <div className="rounded-3xl border border-white/10 bg-white/5 p-4">
                <div className="text-[11px] text-slate-400">Top trade</div>
                <div className="text-[14px] font-extrabold text-slate-100 mt-1">{summary?.tradeSummary?.[0]?.trade ?? "—"}</div>
                <div className="text-[11px] text-slate-400 mt-2">{summary?.tradeSummary?.[0]?.count ? `${summary.tradeSummary[0].count} jobs` : ""}</div>
              </div>
            </div>

            <div className="rounded-3xl border border-white/10 bg-white/5 p-4">
              <div className="text-[12px] font-extrabold text-slate-100">Avg completion by trade</div>
              <div className="mt-3 space-y-2">
                {(summary?.tradeSummary || []).slice(0, 8).map(t => (
                  <div key={t.trade} className="rounded-3xl border border-white/10 bg-black/20 p-3">
                    <div className="flex items-center justify-between">
                      <div className="text-[12px] font-extrabold text-slate-100">{t.trade}</div>
                      <span className="nf-pill">{t.avgMins} mins</span>
                    </div>
                    <div className="text-[11px] text-slate-400 mt-1">{t.count} tasks</div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        );
      }

      function PartnerApi({ toast }) {
        const [access, setAccess] = useState(null);
        const [keys, setKeys] = useState([]);
        const [audit, setAudit] = useState([]);
        const [partnerId, setPartnerId] = useState("p_level39_fm");

        async function refresh() {
          const a = api.getPartnerAccess ? api.getPartnerAccess() : null;
          setAccess(a || null);
          const k = api.listApiKeys ? api.listApiKeys() : [];
          setKeys(Array.isArray(k) ? k : []);
          const l = api.getAuditLog ? await api.getAuditLog() : [];
          setAudit(Array.isArray(l) ? l : []);
        }
        useEffect(() => { refresh(); }, []);

        useDemoBus((raw) => {
          const { topic } = readMsg(raw);
          if (topic === "partnerapi") refresh();
        });

        function createKey() {
          const rec = api.createApiKey ? api.createApiKey(partnerId, ["tickets:write","plc:write","assets:read"], "SANDBOX") : null;
          toast && toast("API key created", "Secret shown once in the event payload (demo).", rec?.keyId || "");
          refresh();
        }
        function rotate(keyId) {
          api.rotateSecret && api.rotateSecret(keyId);
          toast && toast("Secret rotated", "New secret generated (demo).", keyId);
          refresh();
        }
        function revoke(keyId) {
          api.revokeKey && api.revokeKey(keyId);
          toast && toast("Key revoked", "Access disabled (demo).", keyId);
          refresh();
        }

        return (
          <div className="space-y-3">
            <div className="flex items-start justify-between gap-2">
              <div>
                <div className="text-[12px] uppercase tracking-[0.18em] text-slate-300">Partner API</div>
                <div className="text-[11px] text-slate-400">Revolut-style keys, scopes, rate limits, audit trail.</div>
              </div>
              <button className="nf-appbar-btn" onClick={refresh}>Refresh</button>
            </div>

            <div className="rounded-3xl border border-white/10 bg-white/5 p-4">
              <div className="grid grid-cols-1 md:grid-cols-3 gap-2 items-end">
                <div className="md:col-span-2">
                  <div className="text-[11px] text-slate-300 mb-1">Partner</div>
                  <select className="nf-input text-[12px]" value={partnerId} onChange={(e)=>setPartnerId(e.target.value)}>
                    {(access?.partners || []).map(p => <option key={p.partnerId} value={p.partnerId}>{p.name} ({p.type})</option>)}
                  </select>
                </div>
                <div className="flex items-center gap-2">
                  <button className="nf-btn-primary text-[12px]" onClick={createKey}>Create API key</button>
                </div>
              </div>
              <div className="text-[10px] text-slate-500 mt-3">
                Rate limits: {access?.rate?.perMinute ?? 100}/min • {access?.rate?.perDay ?? 10000}/day
              </div>
            </div>

            <div className="rounded-3xl border border-white/10 bg-white/5 p-4">
              <div className="flex items-center justify-between">
                <div className="text-[12px] font-extrabold text-slate-100">API keys</div>
                <span className="nf-pill">{keys.length}</span>
              </div>
              <div className="mt-3 space-y-2 max-h-[360px] overflow-y-auto pr-1">
                {(keys || []).length === 0 ? <div className="text-[11px] text-slate-400">No keys yet.</div> : keys.map(k => (
                  <div key={k.keyId} className="rounded-3xl border border-white/10 bg-black/20 p-3">
                    <div className="flex items-center justify-between">
                      <div className="text-[12px] font-extrabold text-slate-100">{k.env} • {k.status}</div>
                      <span className="nf-pill">{(k.scopes || []).length} scopes</span>
                    </div>
                    <div className="text-[11px] text-slate-400 mt-1 font-mono">
                      apiKey: {k.apiKey} • secret: {k.secretMasked}
                    </div>
                    <div className="mt-3 flex items-center gap-2 flex-wrap">
                      <button className="nf-btn-ghost text-[12px]" onClick={()=>rotate(k.keyId)}>Rotate secret</button>
                      <button className="nf-btn-ghost text-[12px]" onClick={()=>revoke(k.keyId)}>Revoke</button>
                    </div>
                  </div>
                ))}
              </div>
            </div>

            <div className="rounded-3xl border border-white/10 bg-white/5 p-4">
              <div className="flex items-center justify-between">
                <div className="text-[12px] font-extrabold text-slate-100">Audit log</div>
                <span className="nf-pill">{audit.length}</span>
              </div>
              <div className="mt-3 space-y-2 max-h-[360px] overflow-y-auto pr-1">
                {(audit || []).length === 0 ? <div className="text-[11px] text-slate-400">No audit events yet.</div> : audit.map(a => (
                  <div key={a.id} className="rounded-3xl border border-white/10 bg-black/20 p-3">
                    <div className="flex items-center justify-between">
                      <div className="text-[12px] font-extrabold text-slate-100">{a.action || "event"}</div>
                      <span className="nf-pill">{a.partnerId || "—"}</span>
                    </div>
                    <div className="text-[11px] text-slate-400 mt-1 font-mono">keyId: {a.keyId || "—"} • {timeAgo(a.at)}</div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        );
      }
      function WhyNotfallScreen({ role }) {
        return (
          <div className="space-y-4">
            <div className="flex items-start justify-between gap-3 flex-wrap">
              <div>
                <div className="text-[12px] uppercase tracking-[0.18em] text-slate-300">Notfall value</div>
                <div className="text-[22px] font-extrabold text-slate-100 mt-1">
                  A premium maintenance network that’s easy to sell.
                </div>
                <div className="text-[12px] text-slate-400 mt-2 max-w-[780px]">
                  Deposit-backed tickets, fast dispatch, certified engineers, and audit-ready workflow logs —
                  designed to scale across domestic, enterprise FM and industrial PLC environments.
                </div>
              </div>
              <div className="flex items-center gap-2">
                <span className="nf-pill">Level39-ready</span>
                <span className="nf-pill">Google-grade patterns</span>
                <span className="nf-pill nf-pill-beta">LIVE BETA</span>
              </div>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-3">
              <div className="rounded-3xl border border-white/10 bg-white/5 p-4">
                <div className="text-[12px] font-extrabold text-slate-100">1) Deposit → escrow buffer</div>
                <div className="text-[11px] text-slate-400 mt-1">
                  Clients/FMs deposit a buffer (e.g., £200) into Revolut-aligned escrow.
                  That underwrites the first payout tranche and reduces disputes.
                </div>
              </div>
              <div className="rounded-3xl border border-white/10 bg-white/5 p-4">
                <div className="text-[12px] font-extrabold text-slate-100">2) Real-time dispatch</div>
                <div className="text-[11px] text-slate-400 mt-1">
                  Offers go to matched engineers. Accept/decline, ETA, onsite confirmation, evidence-gated completion.
                  SLA and risk signals become measurable, not guesswork.
                </div>
              </div>
              <div className="rounded-3xl border border-white/10 bg-white/5 p-4">
                <div className="text-[12px] font-extrabold text-slate-100">3) Certified workforce</div>
                <div className="text-[11px] text-slate-400 mt-1">
                  DAO-style certification makes compliance portable: engineers carry a digital ID credential.
                  Enterprise FM can trust the network faster.
                </div>
              </div>
            </div>

            <div className="rounded-3xl border border-sky-400/20 bg-sky-900/10 p-4">
              <div className="text-[12px] font-extrabold text-slate-100">Role-based demo workflow</div>
              <div className="text-[11px] text-slate-400 mt-1">
                Switch roles at the top: <b>Client/FM</b> raises a ticket → escrow ledger updates →
                <b>Engineer</b> receives offer in inbox → evidence vault gates completion →
                <b>DAO</b> approves engineers and audits escrow + partner APIs.
              </div>
              <div className="mt-3 flex items-center gap-2 flex-wrap">
                <span className="nf-pill">Escrow ledger</span>
                <span className="nf-pill">Ticket cockpit</span>
                <span className="nf-pill">Task inbox</span>
                <span className="nf-pill">Evidence vault</span>
                <span className="nf-pill">Digital ID</span>
                <span className="nf-pill">KPIs</span>
              </div>
            </div>
          </div>
        );
      }

      function DemoAnalyticsScreen() {
        const [summary, setSummary] = useState(null);
        const [loading, setLoading] = useState(false);

        async function load() {
          setLoading(true);
          try {
            api.startFeature && api.startFeature("demo_analytics");
            const data = await (api.getDemoAnalyticsSummary ? api.getDemoAnalyticsSummary() : Promise.resolve(null));
            setSummary(data || null);
            api.endFeature && api.endFeature("demo_analytics");
          } catch {} finally { setLoading(false); }
        }
        useEffect(() => { load(); }, []);

        return (
          <div className="space-y-3">
            <div className="flex items-center justify-between gap-2">
              <div>
                <div className="text-[12px] uppercase tracking-[0.18em] text-slate-300">Demo analytics</div>
                <div className="text-[11px] text-slate-400">Measures demo usage — informs roadmap.</div>
              </div>
              <button className="nf-appbar-btn" onClick={load}>{loading ? "..." : "Refresh"}</button>
            </div>

            <div className="nf-divider" />

            {!summary ? (
              <div className="text-[11px] text-slate-400">No summary yet. Use the demo to generate events.</div>
            ) : (
              <div className="grid grid-cols-1 lg:grid-cols-3 gap-3">
                <div className="rounded-3xl border border-white/10 bg-white/5 p-4">
                  <div className="text-[11px] text-slate-400">Session mins</div>
                  <div className="text-[22px] font-extrabold text-slate-100">{summary.sessionMins || 1}</div>
                </div>
                <div className="rounded-3xl border border-white/10 bg-white/5 p-4">
                  <div className="text-[11px] text-slate-400">Events</div>
                  <div className="text-[22px] font-extrabold text-slate-100">{summary.totalEvents || 0}</div>
                </div>
                <div className="rounded-3xl border border-white/10 bg-white/5 p-4">
                  <div className="text-[11px] text-slate-400">Top widget</div>
                  <div className="text-[14px] font-extrabold text-slate-100">{summary.topWidget || "—"}</div>
                  <div className="text-[11px] text-slate-400 mt-1">{summary.topWidgetMins ? `${summary.topWidgetMins} mins` : ""}</div>
                </div>
              </div>
            )}
          </div>
        );
      }

      function Screen({ id, role, daoApproved, onDaoApproved, toast }) {
        switch (id) {
          case "story_value": return <WhyNotfallScreen role={role} />;
          case "demo_analytics": return <DemoAnalyticsScreen />;
          case "demo_profile": return <div className="rounded-3xl border border-white/10 bg-white/5 p-4 text-[11px] text-slate-400">Use the Demographics button in the header.</div>;

          // Engineer
          case "eng_profile": return <EngineerProfile toast={toast} />;
          case "eng_dao": return <EngineerDaoStatus toast={toast} onApproved={onDaoApproved} />;
          case "eng_inbox": return <EngineerTaskInbox toast={toast} />;
          case "eng_evidence": return <EngineerEvidenceVault toast={toast} />;
          case "eng_id": return <EngineerIdCard toast={toast} daoApproved={daoApproved} />;

          // Client
          case "fm_ticket": return <ClientTicketCockpit toast={toast} />;
          case "fm_escrow": return <EscrowWallet toast={toast} />;
          case "fm_assets": return <AssetsAndPlc toast={toast} />;
          case "fm_pools": return <EngineerPools toast={toast} />;

          // DAO
          case "dao_queue": return <DaoReviewQueue toast={toast} onApproved={onDaoApproved} />;
          case "dao_escrow": return <EscrowWallet toast={toast} />;
          case "dao_kpis": return <DaoKpis />;
          case "dao_partner": return <PartnerApi toast={toast} />;

          default:
            return <div className="rounded-3xl border border-white/10 bg-white/5 p-4 text-[11px] text-slate-400">Unknown screen: {id}</div>;
        }
      }

      function App() {
        const { toasts, push } = useToasts();

        const [role, setRole] = useState("engineer"); // engineer | client | dao
        const [active, setActive] = useState("story_value");
        const [demoProfileOpen, setDemoProfileOpen] = useState(false);
        const [daoApproved, setDaoApproved] = useState(false);

        // Boot role sync
        useEffect(() => {
          (async () => {
            try {
              const r = api.getRole ? await api.getRole() : null;
              const roleStr = String(r?.role || "ENGINEER").toLowerCase();
              const mapped = roleStr.includes("dao") ? "dao" : roleStr.includes("client") ? "client" : "engineer";
              setRole(mapped);
            } catch {}
          })();
        }, []);

        // Auto-set daoApproved based on DAO status
        useEffect(() => {
          (async () => {
            try {
              const s = api.getDAOStatus ? await api.getDAOStatus() : null;
              const st = String(s?.status || s?.state || "").toUpperCase();
              if (st === "APPROVED_CERTIFIED" || st === "APPROVED") setDaoApproved(true);
            } catch {}
          })();
        }, [role]);

        // Listen for DAO approval events globally
        useDemoBus((raw) => {
          const { topic, action, payload } = readMsg(raw);
          if (topic === "dao" && action === "approved") {
            setDaoApproved(true);
            push("DAO approved", "Digital ID unlocked.", payload?.engineerId || "");
          }
          if (topic === "profile" && action === "saved") push("Profile updated", "Profile saved (demo).", payload?.engineerId || "");
          if (topic === "demographics" && action === "updated") push("Demographics saved", "Demo profile updated.", "");
        });

        async function switchRole(next) {
          setRole(next);
          api.track && api.track("role_switched", { role: next });
          try { api.setRole && (await api.setRole(apiRole(next))); } catch {}

          if (next === "engineer") setActive("eng_inbox");
          if (next === "client") setActive("fm_ticket");
          if (next === "dao") setActive("dao_queue");
        }

        function isLocked(w) {
          if (w.gate === "dao_approved" && !daoApproved) return true;
          return false;
        }

        const left = widgetsForRole(role);

        return (
          <div className="nf-root">
            <div className="nf-appbar">
              <div className="nf-appbar-inner">
                <div className="nf-brand">
                  <div className="nf-brand-logo">
                    <div className="text-[12px] font-extrabold tracking-[0.08em] text-white">NOTFALL</div>
                  </div>
                  <div>
                    <div className="nf-brand-title">Notfall Engineers</div>
                    <div className="nf-brand-sub">Multi-role demo cockpit • Engineer / Client-FM / DAO</div>
                  </div>
                </div>

                <div className="nf-appbar-actions">
                  <span className="nf-chip"><span className="nf-chip-dot"></span><span>Online • Demo</span></span>
                  <button className="nf-appbar-btn" onClick={()=>setDemoProfileOpen(true)}>Demographics</button>

                  <div className="flex items-center gap-2">
                    <button className="nf-appbar-btn" onClick={()=>switchRole("engineer")} style={{borderColor: role==="engineer" ? "#38bdf8" : undefined}}>Engineer</button>
                    <button className="nf-appbar-btn" onClick={()=>switchRole("client")}   style={{borderColor: role==="client"   ? "#38bdf8" : undefined}}>Client / FM</button>
                    <button className="nf-appbar-btn" onClick={()=>switchRole("dao")}      style={{borderColor: role==="dao"      ? "#38bdf8" : undefined}}>DAO</button>
                  </div>
                </div>
              </div>
            </div>

            <div className="nf-shell-bg">
              <div className="nf-layout">
                {/* Left: Widget Hub */}
                <div className="nf-panel-widget">
                  <div className="flex items-center justify-between">
                    <div className="nf-nav-title">Widgets</div>
                    <span className="nf-pill">{role.toUpperCase()}</span>
                  </div>
                  <div className="nf-divider"></div>

                  <div className="space-y-2">
                    {left.map((w) => {
                      const locked = isLocked(w);
                      return (
                        <button
                          key={w.id}
                          onClick={() => !locked && setActive(w.id)}
                          className={"nf-nav-item " + (active===w.id ? "active " : "") + (locked ? "locked" : "")}
                          title={locked ? "Locked until DAO approval" : ""}
                        >
                          <div className="flex items-center justify-between gap-2">
                            <div className="t1">{w.label}</div>
                            <div className="flex items-center gap-2">
                              {w.pill ? <span className="nf-pill nf-pill-beta">{w.pill}</span> : null}
                              {locked ? <span className="nf-status-badge nf-status-muted">LOCKED</span> : null}
                            </div>
                          </div>
                          <div className="t2">{w.sub}</div>
                        </button>
                      );
                    })}
                  </div>

                  <div className="nf-divider"></div>
                  <div className="text-[11px] text-slate-400">
                    Locked widgets appear dimmed. Unlock via DAO approval (demo).
                  </div>
                </div>

                {/* Right: Display Panel */}
                <div className="nf-panel-main">
                  <div className="flex items-start justify-between gap-2 flex-wrap">
                    <div>
                      <div className="text-[12px] uppercase tracking-[0.18em] text-slate-300">
                        Active role: <span className="text-slate-100 font-extrabold">{role.toUpperCase()}</span>
                      </div>
                      <div className="text-[11px] text-slate-400 mt-1">
                        Warm, premium UX • simple sales story • consistent widget lifecycle
                      </div>
                    </div>
                    <div className="flex items-center gap-2">
                      <span className="nf-pill">API: notfall_demoAPI</span>
                      <span className="nf-pill">WS: widget bus</span>
                      <span className="nf-pill nf-pill-beta">LIVE BETA</span>
                    </div>
                  </div>

                  <div className="nf-divider"></div>

                  <Screen
                    id={active}
                    role={role}
                    daoApproved={daoApproved}
                    onDaoApproved={() => setDaoApproved(true)}
                    toast={push}
                  />
                </div>
              </div>
            </div>

            <DemographicsModal open={demoProfileOpen} onClose={()=>setDemoProfileOpen(false)} />
            <ToastStack toasts={toasts} />
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
